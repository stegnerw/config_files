#!/usr/bin/env bash
source "$(dirname "$0")/helper.bash"

# --- Environment Variables ---

nproc=$(nproc)
LOAD_WARN="${LOAD_WARN:-$nproc}"
LOAD_CRIT="${LOAD_CRIT:-$(( nproc * 2 ))}"

# --- Core Logic ---

read -r load1 load5 load15 _ < /proc/loadavg

# Click: show full load breakdown
if [ "$BLOCK_BUTTON" -eq 1 ] 2>/dev/null; then
  load_string="${load1} / ${load5} / ${load15} (1m / 5m / 15m)"
  cpu_usage=$(awk '/^cpu / {
    total = 0; idle = $5;
    for (i=2; i<=NF; i++) total += $i;
    printf "%.0f", (1 - idle/total) * 100
  }' /proc/stat)
  notify "System Load" \
    "Load: ${load_string}\nCPU: ${cpu_usage}%\nCores: ${nproc}"
fi

color=$(threshold_color "$load1" "$LOAD_WARN" "$LOAD_CRIT")
echo " ${load1}"
echo ""
echo "$color"
