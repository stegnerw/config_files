#!/usr/bin/env bash
source "$(dirname "$0")/helper.bash"

# --- Environment Variables ---

RAM_WARN="${RAM_WARN:-60}"
RAM_CRIT="${RAM_CRIT:-85}"

# --- Core Logic ---

# Parse /proc/meminfo (values in kB)
eval "$(awk '/^MemTotal:/ {print "mem_total=" $2}
             /^MemAvailable:/ {print "mem_avail=" $2}' /proc/meminfo)"

mem_used=$(( mem_total - mem_avail ))
pct=$(( mem_used * 100 / mem_total ))

# Click: show used/total
if [ "$BLOCK_BUTTON" -eq 1 ] 2>/dev/null; then
  # Human-readable values
  used_gib=$(echo "scale=1; $mem_used / 1048576" | bc)
  total_gib=$(echo "scale=1; $mem_total / 1048576" | bc)

  show_popup "Memory" \
    "Used: ${used_gib} GiB / ${total_gib} GiB (${pct}%)"
fi

color=$(threshold_color "$pct" "$RAM_WARN" "$RAM_CRIT")
echo " ${pct}%"
echo ""
echo "$color"
