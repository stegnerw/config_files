#!/bin/bash
# docscan [title] [profile] [options]
# profile: "practice" (600 dpi PNG), "archive" (2400 dpi TIFF+PNG)

# Clean up tmp files on exit
tmp_files=()
cleanup() {
  for f in "${tmp_files[@]}"; do
    rm -f "$f"
  done
}
trap cleanup EXIT

# Ensure all required commands are here
for cmd in scanimage magick feh notify-send; do
  command -v "$cmd" &>/dev/null || { echo "Missing: $cmd"; exit 1; }
done

show_usage() {
  echo "Usage: $0 [title] [practice|archive] [options]"
  echo "Options:"
  echo "  --help, -h             Print this help message and exit"
  echo "  --no-preview, -P       Skip the preview before scanning"
  echo "  --rotation|-r [deg]   Rotate image (0|90|180|270)"
  echo "  --size|-s [size]      Paper size (Letter|Legal|A4|A5)"
  echo "  --dpi, -d [dpi]        DPI resolution (auto|75|150|300|600|1200|2400)"
  echo "  --format, -f [format]  File format (pnm|tiff|png|jpeg|pdf)"
  echo "  --view, -v             View the file at the end of scanning"
  echo ""
  echo "Examples:"
  echo "  $0 certificate archive --no-preview --size A5"
  echo "  $0 practice_sheet practice -P -r 90"
  exit 1
}

# Early exit for --help anywhere in args
for arg in "$@"; do
  case "$arg" in
    --help|-h) show_usage; exit 0 ;;
  esac
done

# Named parameters
title="$1"
profile="${2:-practice}"

if [[ -z "$title" || "$title" == -* ]]; then
  echo "Error: title is required, got: $title"
  show_usage
  exit 1
fi

# Guard the shift â€” only shift what we actually have
if [[ $# -ge 2 ]]; then
  shift 2
elif [[ $# -ge 1 ]]; then
  shift 1
fi

# Default values and constants
timestamp=$(date +%Y-%m-%dT%H%M%S)
filename="${timestamp}_${title}"
rotation="0"
size="Letter"
skip_preview=false
device="pixma:04A91913_5C6D6A"

# Parse optional flags
while [[ $# -gt 0 ]]; do
  case $1 in
    --no-preview|-P)
      skip_preview=true
      shift
      ;;
    --rotation|-r)
      rotation="$2"
      shift 2
      case "$rotation" in
        0|90|180|270) ;;
        *) echo "Error: Rotation is $rotation: must be 0|90|180|270"; exit 1; ;;
      esac
      ;;
    --size|-s)
      size="$2"
      shift 2
      ;;
    --dpi|-d)
      dpi="$2"
      shift 2
      case "$dpi" in
        auto|75|150|300|600|1200|2400) ;;
        *)
          echo "Error: Unsupported DPI - $dpi"
          show_usage
          exit 1
          ;;
      esac
      ;;
    --format|-f)
      format="$2"
      shift 2
      case "$format" in
        pnm|tiff|png|jpeg|pdf) ;;
        *)
          echo "Error: Unsupported format - $format"
          show_usage
          exit 1
          ;;
      esac
      ;;
    --view|-v)
      view_result=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Dropbox paths
archive_dir="$HOME/Dropbox/calligraphy/archive"
practice_dir="$HOME/Dropbox/calligraphy/practice"

mkdir -p "$archive_dir" "$practice_dir"

# Paper size dimensions in mm
case "${size}" in
    Letter)
      width=215.9
      height=279.4
      ;;
    Legal)
      width=215.9
      height=355.6
      ;;
    A4)
      width=210
      height=297
      ;;
    A5)
      width=148
      height=210
      ;;
    *)
      echo "Error: Unknown size - $size"
      show_usage
      exit 1
      ;;
esac

# Usage: do_scan resolution format output_file
do_scan() {
  local resolution=${1}
  local format=${2}
  local output_file=${3}
  local tmp_file=$(mktemp /tmp/docscan_XXXXXXXXXX.${format})
  tmp_files+=("$tmp_file")

  echo "Scanning at ${resolution} DPI ($size) -> ${output_file}"
  scanimage --device "${device}" \
            --progress \
            --resolution "${resolution}" \
            --format="${format}" \
            --mode Color \
            -x "${width}" \
            -y "${height}" \
            > "${tmp_file}" \
            || { echo "Error: scanimage failed"; exit 1; }

  if [ "${rotation}" != "0" ]; then
    echo "Rotating ${rotation} degrees..."
    magick "${tmp_file}" -rotate "${rotation}" "${tmp_file}" \
      || { echo "Error: magick failed"; exit 1; }
  fi

  mv "${tmp_file}" "${output_file}" \
    || { echo "Error: failed to move temp file to output location"; exit 1; }
}

show_preview() {
  local preview_file=$(mktemp /tmp/docscan_XXXXXXXXXX.png)
  tmp_files+=("$preview_file")
  do_scan 75 png "${preview_file}"

  feh "$preview_file" &
  feh_pid=$!

  echo ""
  read -p "Preview displayed. Proceed with $profile scan? (y/n): " -n 1 -r
  kill ${feh_pid} 2>/dev/null
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Scan cancelled."
    exit 0
  fi
}

# Show preview if requested
if ! [ "$skip_preview" = true ]; then
  show_preview
fi

# Main scan
case "$profile" in
  archive)
    dpi=${dpi:-2400}
    format=${format:-tiff}
    output_file="${archive_dir}/${filename}.${format}"
    ;;

  practice)
    dpi=${dpi:-600}
    format=${format:-png}
    output_file="${practice_dir}/${filename}.${format}"
    ;;

  *)
    echo "Unknown profile: $profile"
    show_usage
    exit 1
    ;;
esac

do_scan "$dpi" "$format" "${output_file}"
echo "Saved: ${output_file}"

notify-send --urgency=normal --icon=scanner "Scan Complete" "$(basename ${output_file})"
if [ "$view_result" = true ]; then
  feh --scale-down "${output_file}"
fi
