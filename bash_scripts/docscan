#!/bin/bash
# docscan [title] [type] [options]
# type: "practice" (1200 dpi PNG), "archive" (2400 dpi TIFF+PNG)
# options: --preview (show preview first), --rotation [0|90|180|270], --size [Letter|Legal|A4|A5]

title="$1"
type="${2:-practice}"
rotation="0"
size="Letter"
preview_mode=false
device="pixma:04A91913_5C6D6A"

show_usage() {
  echo "Usage: $0 [title] [practice|archive] [options]"
  echo "Options:"
  echo "  --help, -h             Print this help message and exit"
  echo "  --no-preview, -P       Skip the preview before scanning"
  echo "  --rotation, -r [deg]   Rotate image (0, 90, 180, 270)"
  echo "  --size, -s [size]      Paper size (Letter, Legal, A4, A5)"
  echo "  --dpi, -d [dpi]        DPI resolution (auto|75|150|300|600|1200|2400)"
  echo "  --format, -f [format]  File format (pnm|tiff|png|jpeg|pdf)"
  echo "  --view, -v             View the file at the end of scanning"
  echo ""
  echo "Examples:"
  echo "  $0 certificate archive --preview --size A5"
  echo "  $0 practice_sheet practice -p -r 90"
  exit 1
}

# Parse optional flags
shift 2
while [[ $# -gt 0 ]]; do
  case $1 in
    --help|-h)
      show_usage
      exit 0
      ;;
    --no-preview|-P)
      skip_preview=true
      shift
      ;;
    --rotation|-r)
      rotation="$2"
      shift 2
      ;;
    --size|-s)
      size="$2"
      shift 2
      ;;
    --dpi|-d)
      dpi="$2"
      shift 2
      case "$dpi" in
        auto|75|150|300|600|1200|2400) ;;
        *)
          echo "Error: Unsupported DPI - $dpi"
          show_usage
          exit 1
          ;;
      esac
      ;;
    --format|-f)
      format="$2"
      shift 2
      case "$format" in
        pnm|tiff|png|jpeg|pdf) ;;
        *)
          echo "Error: Unsupported format - $format"
          show_usage
          exit 1
          ;;
      esac
      ;;
    --view|-v)
      view_result=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

date=$(date +%Y-%m-%d)
filename="${date}_${title}"

# Dropbox paths
archive_dir="$HOME/Dropbox/calligraphy/archive"
practice_dir="$HOME/Dropbox/calligraphy/practice"

mkdir -p "$archive_dir" "$practice_dir"

# Paper size dimensions in mm
case "${size:-Letter}" in
    Letter)
      width=215.9
      height=279.4
      ;;
    Legal)
      width=215.9
      height=355.6
      ;;
    A4)
      width=210
      height=297
      ;;
    A5)
      width=148
      height=210
      ;;
    *)
      echo "Error: Unknown size - $size"
      width=215.9
      height=279.4
      ;;
esac

# Usage: do_scan resolution format output_file
do_scan() {
  local resolution=${1}
  local format=${2}
  local output_file=${3}
  local tmp_file="/tmp/$(basename ${output_file})"

  echo "Scanning at ${resolution} DPI ($size) -> ${output_file}"
  scanimage --device ${device} \
            --progress \
            --resolution "${resolution}" \
            --format="${format}" \
            --mode Color \
            -x "${width}" \
            -y "${height}" \
            > "${output_file}"

  if [ "${rotation}" != "0" ]; then
    echo "Rotating ${rotation} degrees..."
    magick "${output_file}" -rotate "${rotation}" "${output_file}"
  fi
}

show_preview() {
  local preview_file="/tmp/scan_preview_${date}.png"
  do_scan 75 png "${preview_file}"

  feh "$preview_file" &
  feh_pid=$!

  echo ""
  read -p "Preview displayed. Proceed with $type scan? (y/n): " -n 1 -r
  kill ${feh_pid} 2>/dev/null
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Scan cancelled."
    exit 0
  fi
}

# Show preview if requested
if ! [ "$skip_preview" = true ]; then
  show_preview
fi

# Main scan
case "$type" in
  archive)
    dpi=${dpi:-2400}
    format=${format:-tiff}
    output_file="${archive_dir}/${filename}.${format}"
    ;;

  practice)
    dpi=${dpi:-1200}
    format=${format:-png}
    output_file="${practice_dir}/${filename}.${format}"
    ;;

  *)
    echo "Unknown type: $type"
    show_usage
    exit 1
    ;;
esac

do_scan $dpi $format "${output_file}"
echo "Saved: ${output_file}"

notify-send --urgency=normal --icon=scanner "Scan Complete" "$(basename ${output_file})"
if [ "$view_result" = true ]; then
  feh --scale-down "${output_file}"
fi
