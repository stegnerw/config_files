#!/bin/bash
# docscan [title] [profile] [options]
# profile: "practice" (600 dpi PNG), "archive" (2400 dpi TIFF+PNG)

# Clean up tmp files on exit
tmp_files=()
cleanup() {
  for f in "${tmp_files[@]}"; do
    rm -f "$f"
  done
}
trap cleanup EXIT

# Ensure all required commands are here
for cmd in scanimage magick feh notify-send; do
  command -v "$cmd" &>/dev/null || { echo "Missing: $cmd"; exit 1; }
done

# Validation regex
valid_profiles="archive|practice"
valid_rotations="0|90|180|270"
valid_sizes="Letter|Legal|A4|A5"
valid_dpis="auto|75|150|300|600|1200|2400"
valid_formats="jpeg|pdf|png|pnm|tiff"
valid_modes="Color|Gray|Lineart"

show_usage() {
  echo "Usage: $0 title [$valid_profiles] [options]"
  echo "Options:"
  echo "  --help, -h              Print this help message and exit"
  echo "  --profile, -p [profile] Scan profile ($valid_profiles)"
  echo "  --no-preview, -P        Skip the preview before scanning"
  echo "  --rotation|-r [deg]     Rotate image ($valid_rotations)"
  echo "  --size|-s [size]        Paper size ($valid_sizes)"
  echo "  --dpi, -d [dpi]         DPI resolution ($valid_dpis)"
  echo "  --format, -f [format]   File format ($valid_formats)"
  echo "  --view, -v              View the file at the end of scanning"
  echo "  --mode, -m [mode]       Color mode ($valid_modes)"
  echo ""
  echo "Examples:"
  echo "  $0 certificate archive --no-preview --size A5"
  echo "  $0 practice_sheet practice -P -r 90"
  exit 1
}

# Early exit for --help anywhere in args
for arg in "$@"; do
  if [[ "$arg" =~ ^(--help|-h)$ ]]; then
    show_usage
    exit 0
  fi
done

# Required parameters
title="$1"
shift 1
if [[ -z "$title" || "$title" == -* ]]; then
  echo "Error: title is required, got: $title"
  show_usage
  exit 1
fi

# Non-user-defined values
timestamp=$(date +%Y-%m-%dT%H%M%S)
filename="${timestamp}_${title}"
device="pixma:04A91913_5C6D6A"

# Default values for flags
profile="practice"
rotation="0"
size="A5"
skip_preview=false

# Parse optional flags
bad_flags=0
while [[ $# -gt 0 ]]; do
  case $1 in
    --profiles|-p)
      profile="$2"
      shift 2
      if [[ ! "$profile" =~ ^($valid_profiles)$ ]]; then
        echo "Error: Unsupported profile - $profile"
        bad_flags=$((bad_flags+1))
      fi
      ;;
    --no-preview|-P)
      skip_preview=true
      shift
      ;;
    --rotation|-r)
      rotation="$2"
      shift 2
      if [[ ! "$rotation" =~ ^($valid_rotations)$ ]]; then
        echo "Error: Unsupported rotation - $rotation"
        bad_flags=$((bad_flags+1))
      fi
      ;;
    --size|-s)
      size="$2"
      shift 2
      if [[ ! "$size" =~ ^($valid_sizes)$ ]]; then
        echo "Error: Unsupported size - $size"
        bad_flags=$((bad_flags+1))
      fi
      ;;
    --dpi|-d)
      dpi="$2"
      shift 2
      if [[ ! "$dpi" =~ ^($valid_dpis)$ ]]; then
        echo "Error: Unsupported DPI - $dpi"
        bad_flags=$((bad_flags+1))
      fi
      ;;
    --format|-f)
      format="$2"
      shift 2
      if [[ ! "$format" =~ ^($valid_formats)$ ]]; then
        echo "Error: Unsupported format - $format"
        bad_flags=$((bad_flags+1))
      fi
      ;;
    --view|-v)
      view_result=true
      shift
      ;;
    --mode|-m)
      mode="$2"
      shift 2
      if [[ ! "$mode" =~ ^($valid_modes)$ ]]; then
        echo "Error: Unsupported mode - $mode"
        bad_flags=$((bad_flags+1))
      fi
      ;;
    *)
      echo "Unknown option: $1"
      shift
      bad_flags=$((bad_flags+1))
      ;;
  esac
done

if [[ $bad_flags -gt 0 ]]; then
  echo "Error: $bad_flags bad flag(s) detected"
  show_usage
  exit 1
fi

# Dropbox paths
archive_dir="$HOME/Dropbox/calligraphy/archive"
practice_dir="$HOME/Dropbox/calligraphy/practice"

mkdir -p "$archive_dir" "$practice_dir"

# Paper size dimensions in mm
case "${size}" in
    Letter)
      width=215.9
      height=279.4
      ;;
    Legal)
      width=215.9
      height=355.6
      ;;
    A4)
      width=210
      height=297
      ;;
    A5)
      width=148
      height=210
      ;;
    *)
      echo "Error: Unknown size - $size"
      show_usage
      exit 1
      ;;
esac

# Usage: do_scan resolution format output_file
do_scan() {
  local resolution=${1}
  local format=${2}
  local output_file=${3}
  if [[ "${output_file}" == /tmp/* ]]; then
    local tmp_file="${output_file}"
  else
    local tmp_file=$(mktemp /tmp/docscan_XXXXXXXXXX.${format})
    tmp_files+=("$tmp_file")
  fi

  echo "Scanning at ${resolution} DPI ($size) -> ${output_file}"
  scanimage --device "${device}" \
            --progress \
            --resolution "${resolution}" \
            --format="${format}" \
            --mode Color \
            -x "${width}" \
            -y "${height}" \
            > "${tmp_file}" \
            || { echo "Error: scanimage failed"; exit 1; }

  if [ "${rotation}" != "0" ]; then
    echo "Rotating ${rotation} degrees..."
    magick "${tmp_file}" -rotate "${rotation}" "${tmp_file}" \
      || { echo "Error: magick failed"; exit 1; }
  fi

  if [[ "${tmp_file}" != "${output_file}" ]]; then
    mv "${tmp_file}" "${output_file}" || {
      echo "Error: failed to move temp file to output location"
      exit 1
    }
  fi
}

show_preview() {
  local preview_file=$(mktemp /tmp/docscan_XXXXXXXXXX.png)
  tmp_files+=("$preview_file")
  do_scan 75 png "${preview_file}"

  feh "$preview_file" &
  feh_pid=$!

  echo ""
  read -p "Preview displayed. Proceed with $profile scan? (y/n): " -n 1 -r
  kill ${feh_pid} 2>/dev/null
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Scan cancelled."
    exit 0
  fi
}

# Show preview if requested
if ! [ "$skip_preview" = true ]; then
  show_preview
fi

# Main scan
case "$profile" in
  archive)
    dpi=${dpi:-2400}
    format=${format:-tiff}
    mode=${mode:-Color}
    output_file="${archive_dir}/${filename}.${format}"
    ;;

  practice)
    dpi=${dpi:-600}
    format=${format:-png}
    mode=${mode:-Gray}
    output_file="${practice_dir}/${filename}.${format}"
    ;;

  *)
    echo "Unknown profile: $profile"
    show_usage
    exit 1
    ;;
esac

do_scan "$dpi" "$format" "${output_file}"
echo "Saved: ${output_file}"

notify-send --urgency=normal --icon=scanner "Scan Complete" "$(basename ${output_file})"
if [ "$view_result" = true ]; then
  feh --scale-down "${output_file}"
fi
